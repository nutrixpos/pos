name: GitHub Actions Demo
run-name: Packaging a new nutrixpos version ðŸš€
on:
  push:
    tags: 
      - "v*.*.*"

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: npm install
        working-directory: ./frontend
      - name: Build frontend
        env:
          NODE_OPTIONS: --max_old_space_size=2048
        run: npm run build-only
        working-directory: ./frontend
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: ./frontend/dist

      - name: Build golang app
        run: export GOOS=windows; go build -o nutrixpos.exe .
        working-directory: ./

      - name: Upload golang artifact
        uses: actions/upload-artifact@v4
        with:
          name: golang
          path: ./nutrixpos.exe

      - name: Install NSIS
        run: |
          sudo apt update -y
          sudo apt -y install nsis
      - name: Print NSIS version
        run: makensis -VERSION
      - name: Print NSIS compile flags
        run: makensis -HDRINFO

      - name: Create nsis-runtime dir
        run: mkdir nsis-runtime

      - name: Download earlier artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: ./dist

      - name: prepare required files to nsis-runtime
        run: |
          mv ./dist ./nsis-runtime/frontend
          mv ./nutrixpos.exe ./nsis-runtime/nutrixpos.exe
          cp ./package.nsi ./nsis-runtime/package.nsi
          sed -i "s/nutrixpos-installer.msi/nutrixpos-${GITHUB_TAG_NAME}-windows64.msi/g" ./nsis-runtime/package.nsi
          cp ./LICENSE ./nsis-runtime/license.txt
          cp ./config.example.yaml ./nsis-runtime/config.yaml

      - name: Download nssm
        run: |
          curl -L -o ./nsis-runtime/nssm-2.24-101-g897c7ad.zip https://nssm.cc/ci/nssm-2.24-101-g897c7ad.zip
          unzip ./nsis-runtime/nssm-2.24-101-g897c7ad.zip -d ./nsis-runtime
          cp ./nsis-runtime/nssm-2.24-101-g897c7ad/win64/nssm.exe ./nsis-runtime/nssm.exe

      - name: Download golang artifact
        uses: actions/download-artifact@v4
        with:
          name: golang
          path: ./nutrixpos.exe

      - name: Download icon and mongodb installer
        run: |
          curl -L -o ./nsis-runtime/icon.ico https://elmawardy.sirv.com/nutrix-icon-0.ico
          curl -L -o ./nsis-runtime/mongodb-windows-x86_64-8.2.1-signed.msi https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-8.2.1-signed.msi

      - name: Run makensis
        working-directory: ./nsis-runtime
        run: makensis package.nsi


      - name: Create Release and Upload MSI
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: ./nsis-runtime/nutrixpos-${github.ref_name}-windows64.msi